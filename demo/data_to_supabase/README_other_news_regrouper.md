# 「其他新聞」分支重新分群工具

## 功能說明

此工具用於遍歷所有主題的「其他新聞」分支，使用 AI 智能分析並重新分群，將相關新聞組織成有意義的新分支。

### 主要特點

1. **智能分群**：使用 Gemini AI 分析新聞內容，自動識別相關主題並分組
2. **靈活設置**：可設定每個分支的最少新聞數量要求
3. **批量處理**：支援處理所有主題或單一主題
4. **測試模式**：提供測試模式，可預覽分群結果而不實際修改資料庫
5. **互動確認**：在處理前可選擇是否自動確認或逐一確認

### 參考設計

此工具的分群邏輯參考了 `complete_news_grouper.py` 的設計：
- 使用相同的 AI 提示語策略
- 避免過度細分新聞
- 確保每個分組有足夠的新聞數量
- 允許部分新聞保留在「其他新聞」分支

## 使用方式

### 命令列模式

#### 1. 測試模式（不寫入資料庫）

```bash
# 測試所有主題
python other_news_regrouper.py test

# 測試單一主題
python other_news_regrouper.py test <topic_id>
```

**範例**：
```bash
python other_news_regrouper.py test affb7eba-6fd4-4461-b9f9-a2f0e2f8ae1c
```

#### 2. 處理模式（會寫入資料庫）

```bash
# 處理所有主題（會逐一詢問確認）
python other_news_regrouper.py process

# 處理所有主題（自動確認，不詢問）
python other_news_regrouper.py process --auto

# 處理單一主題
python other_news_regrouper.py process <topic_id>
```

**範例**：
```bash
# 處理單一主題
python other_news_regrouper.py process affb7eba-6fd4-4461-b9f9-a2f0e2f8ae1c

# 自動處理所有主題
python other_news_regrouper.py process --auto
```

#### 3. 查看幫助

```bash
python other_news_regrouper.py --help
```

### 互動模式

直接執行程式，不帶任何參數：

```bash
python other_news_regrouper.py
```

然後按照提示選擇：
1. 處理單一主題
2. 處理所有主題
3. 測試模式（查看分群結果，不寫入資料庫）

## 處理流程

### 單一主題處理流程

1. **尋找分支**：查找指定主題的「其他新聞」分支
2. **獲取新聞**：獲取該分支中的所有新聞內容
3. **檢查數量**：確認新聞數量是否達到最少要求（預設 3 則）
4. **AI 分析**：使用 Gemini AI 分析新聞內容並進行分群
5. **顯示結果**：顯示建議的新分支和分群結果
6. **確認執行**：詢問使用者是否執行（非測試模式）
7. **創建分支**：創建新的分支並移動新聞
8. **保留剩餘**：無法分組的新聞保留在「其他新聞」分支

### 批量處理流程

1. **尋找主題**：查找所有擁有「其他新聞」分支的主題
2. **逐一處理**：對每個主題執行單一主題處理流程
3. **統計總結**：完成後顯示總體統計資訊

## 分群規則

### AI 分群準則

1. **共同主題**：新聞內容圍繞同一核心事件或議題
2. **內容相關性**：同一組內的新聞探討事件的不同面向
3. **避免過度細分**：優先合併相關事件
4. **合理組規模**：每組至少包含指定數量的新聞（預設 3 則）
5. **單一歸屬**：每則新聞只能屬於一個分組
6. **允許未分配**：無法分組的新聞保留在原「其他新聞」分支

### 不會創建的分組類型

- 「其他」類別的分組
- 「未分類」或「雜項」分組
- 主題不明確或過於籠統的分組

## 輸出結果

### 處理成功後會顯示

- 創建的新分支數量
- 移動的新聞數量
- 保留在「其他新聞」分支的新聞數量
- 每個新分支的詳細資訊（標題、描述、包含的新聞數）

### 範例輸出

```
============================================================
分群結果
============================================================
可組成新分支數: 2
將移動新聞數: 8
保留在「其他新聞」: 3 則

建議分支 1:
  標題: 氣候變遷影響
  描述: 探討全球氣候變遷對各地區的影響及應對措施
  包含新聞數: 5
  理由: 多則新聞討論氣候變遷的不同面向

建議分支 2:
  標題: 新能源政策
  描述: 各國推動的新能源政策與發展現況
  包含新聞數: 3
  理由: 聚焦於新能源政策的實施與效果

============================================================
處理完成
============================================================
成功創建: 2 個新分支
總共移動: 8 則新聞
保留在「其他新聞」: 3 則新聞
```

## 注意事項

### 使用前準備

1. **環境設定**：確保 `.env` 檔案中已設定：
   - `SUPABASE_URL`
   - `SUPABASE_KEY`
   - `GEMINI_API_KEY`

2. **安裝套件**：
   ```bash
   pip install supabase
   pip install google-generativeai
   pip install python-dotenv
   ```

### 使用建議

1. **先測試後執行**：建議先使用測試模式預覽結果
2. **適當的新聞數量**：建議「其他新聞」分支至少有 5-10 則新聞時再執行
3. **定期執行**：建議在 `topic_group_update.py` 處理完新新聞後執行
4. **檢查結果**：執行後應檢查新創建的分支是否符合預期

### 限制與考量

1. **AI 分析品質**：分群結果依賴 AI 的判斷，可能需要人工調整
2. **API 限制**：大量處理時注意 Gemini API 的使用限制
3. **最少新聞數**：預設每組至少需要 3 則新聞，可根據需求調整
4. **執行時間**：處理大量主題時可能需要較長時間

## 與其他工具的整合

### 建議的工作流程

1. **初始分群**：使用 `complete_news_grouper.py` 進行初始的新聞分群
2. **新新聞處理**：使用 `topic_group_update.py` 將新新聞分配到現有分支
3. **重新分群**：定期使用 `other_news_regrouper.py` 重新分析「其他新聞」分支

### 相容性

- 與 `complete_news_grouper.py` 使用相同的分群邏輯
- 與 `topic_group_update.py` 的資料結構完全相容
- 資料庫操作與現有系統一致

## 疑難排解

### 常見問題

**Q: 執行後沒有創建任何新分支？**
A: 可能原因：
- 「其他新聞」分支中的新聞數量不足
- AI 判斷無法組成有意義的分組
- 新聞主題過於分散

**Q: 創建的分支數量比預期少？**
A: AI 會避免過度細分，優先合併相關事件。可以檢視測試模式的輸出了解分群邏輯。

**Q: 有些新聞沒有被移動？**
A: 這是正常的。無法明確分類的新聞會保留在「其他新聞」分支，以便後續處理。

**Q: 如何調整每組的最少新聞數？**
A: 修改程式中的 `min_news_for_branch` 參數（預設為 3）。

## 版本歷史

- **v1.0.0** (2025-01-18)
  - 初始版本
  - 實現基本的分群功能
  - 支援批量和單一主題處理
  - 提供測試模式

## 授權

此工具為 Bee Ya Project 的一部分。
