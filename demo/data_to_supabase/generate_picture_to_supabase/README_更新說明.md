# news_grouper_update.py 更新說明

## 修改日期
2025年11月11日

## 主要修改

### 新增功能：處理未分支新聞

腳本已修改為專門處理**專題中尚未分入分支的新聞**。

### 工作流程

1. **搜尋未分支新聞**
   - 掃描所有專題，找出尚未分入任何分支的新聞
   - 對比 `topic_news_map` 和 `topic_branch_news_map` 資料表

2. **智能比對現有分支**
   - 使用 AI (Gemini) 判斷新聞是否適合加入現有分支
   - 逐一與每個既有分支進行比對
   - 相關度高的新聞會自動加入對應分支

3. **處理無法匹配的新聞**
   - 無法加入現有分支的新聞會存入「其他新聞」分支
   - 合併既有的「其他新聞」分支內容

4. **自動重新分組**
   - 當「其他新聞」分支達到 5 篇或以上時
   - 自動使用 AI 重新分組這些新聞
   - 生成新的正式分支（每個分支至少 5 篇）
   - 不足 5 篇的繼續保留在「其他新聞」分支

### 新增的核心方法

1. `fetch_unbranched_news_for_topic(topic_id)`
   - 獲取某主題中尚未分入任何分支的新聞

2. `process_unbranched_news_for_topic(topic_id, save_to_db=True)`
   - 處理單個主題的未分支新聞
   - 實現完整的比對、分類、重新分組流程
   - 可選擇是否寫入資料庫（預設為預覽模式）

### 修改的主程式入口

`main()` 函數已完全重寫：
- 遍歷所有主題，處理每個主題的未分支新聞
- 提供詳細的處理進度和統計資訊
- 預設為預覽模式（`save_to_db = False`）

## 使用方式

### 1. 預覽模式（推薦）

```bash
python news_grouper_update.py
```

預設會：
- 顯示所有未分支新聞的處理過程
- 輸出詳細的統計資訊
- **不會**實際寫入資料庫

### 2. 寫入資料庫

修改 `main()` 函數中的設定：

```python
save_to_db = True  # 改為 True
```

然後執行：

```bash
python news_grouper_update.py
```

## 輸出資訊

腳本會顯示：
- 每個主題的處理狀態
- 未分支新聞數量
- 成功加入現有分支的新聞數量
- 無法加入現有分支的新聞數量
- 新生成的分支資訊
- 總體統計摘要

## 資料庫操作

寫入資料庫時會執行：
1. 更新 `topic_branch_news_map` - 加入新聞到現有分支
2. 更新或創建「其他新聞」分支
3. 創建新生成的分支（如果有）
4. 刪除已重新分組的舊「其他新聞」分支

## 注意事項

1. **首次執行建議使用預覽模式**，檢查結果後再寫入資料庫
2. **最小分支規模固定為 5 則新聞**
3. AI 比對需要 Gemini API，請確保環境變數設定正確
4. 處理大量主題時可能需要較長時間

## 環境需求

- Python 3.7+
- supabase-py
- google-genai
- python-dotenv

環境變數：
- `SUPABASE_URL`
- `SUPABASE_KEY`
- `GEMINI_API_KEY`
